name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run tests
        run: |
          xcodebuild test \
            -project Mumble.xcodeproj \
            -scheme Mumble \
            -destination "platform=macOS,arch=arm64" \
            -derivedDataPath "$RUNNER_TEMP/DerivedDataTests" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty

      - name: Import signing certificate
        env:
          P12_BASE64: ${{ secrets.DEVELOPER_ID_APPLICATION_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        run: |
          CERT_PATH="$RUNNER_TEMP/certificate.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"

          echo -n "$P12_BASE64" | base64 --decode -o "$CERT_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

      - name: Build
        run: |
          xcodebuild build \
            -target Mumble \
            -configuration Release \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            CODE_SIGN_INJECT_BASE_ENTITLEMENTS=NO \
            OTHER_CODE_SIGN_FLAGS=--timestamp \
            SYMROOT="$RUNNER_TEMP/build" \
            | xcpretty

      - name: Verify code signature
        run: |
          APP_PATH="$RUNNER_TEMP/build/Release/Mumble.app"
          codesign --verify --deep --strict "$APP_PATH"
          codesign -d --verbose=2 "$APP_PATH" 2>&1 | grep -q "flags=0x10000(runtime)"

      - name: Notarize
        timeout-minutes: 50
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          APP_PATH="$RUNNER_TEMP/build/Release/Mumble.app"
          ZIP_PATH="$RUNNER_TEMP/Mumble-notarize.zip"

          ditto -c -k --keepParent "$APP_PATH" "$ZIP_PATH"

          SUBMIT_OUT=$(xcrun notarytool submit "$ZIP_PATH" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait --timeout 45m 2>&1) || true
          echo "$SUBMIT_OUT"

          SUBMISSION_ID=$(echo "$SUBMIT_OUT" | grep '  id:' | head -1 | awk '{print $2}')

          if echo "$SUBMIT_OUT" | grep -q "status: Accepted"; then
            echo "Notarization accepted!"
          else
            echo "Notarization failed. Fetching log…"
            xcrun notarytool log "$SUBMISSION_ID" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_ID_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              /dev/stdout || true
            exit 1
          fi

      - name: Staple notarization ticket
        run: |
          APP_PATH="$RUNNER_TEMP/build/Release/Mumble.app"
          for i in 1 2 3; do
            if xcrun stapler staple "$APP_PATH"; then
              exit 0
            fi
            echo "Staple attempt $i failed, waiting 15s for ticket propagation…"
            sleep 15
          done
          echo "Stapling failed after 3 attempts"
          exit 1

      - name: Package DMG for release
        run: |
          APP_PATH="$RUNNER_TEMP/build/Release/Mumble.app"
          RELEASE_DMG="$RUNNER_TEMP/Mumble.dmg"
          STAGE_DIR="$RUNNER_TEMP/dmg-staging"

          rm -rf "$STAGE_DIR"
          mkdir -p "$STAGE_DIR"
          cp -R "$APP_PATH" "$STAGE_DIR/Mumble.app"
          ln -s /Applications "$STAGE_DIR/Applications"

          hdiutil create \
            -volname "Mumble" \
            -srcfolder "$STAGE_DIR" \
            -ov \
            -format UDZO \
            "$RELEASE_DMG"

          codesign --force --timestamp --sign "Developer ID Application" "$RELEASE_DMG"
          codesign --verify --verbose "$RELEASE_DMG"

          echo "RELEASE_DMG=$RELEASE_DMG" >> "$GITHUB_ENV"

      - name: Notarize DMG
        timeout-minutes: 50
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          RELEASE_DMG="$RUNNER_TEMP/Mumble.dmg"

          SUBMIT_OUT=$(xcrun notarytool submit "$RELEASE_DMG" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait --timeout 45m 2>&1) || true
          echo "$SUBMIT_OUT"

          SUBMISSION_ID=$(echo "$SUBMIT_OUT" | grep '  id:' | head -1 | awk '{print $2}')

          if echo "$SUBMIT_OUT" | grep -q "status: Accepted"; then
            echo "DMG notarization accepted!"
          else
            echo "DMG notarization failed. Fetching log…"
            if [ -n "$SUBMISSION_ID" ]; then
              xcrun notarytool log "$SUBMISSION_ID" \
                --apple-id "$APPLE_ID" \
                --password "$APPLE_ID_PASSWORD" \
                --team-id "$APPLE_TEAM_ID" \
                /dev/stdout || true
            fi
            exit 1
          fi

      - name: Staple DMG notarization ticket
        run: |
          RELEASE_DMG="$RUNNER_TEMP/Mumble.dmg"
          for i in 1 2 3; do
            if xcrun stapler staple "$RELEASE_DMG"; then
              exit 0
            fi
            echo "DMG staple attempt $i failed, waiting 15s for ticket propagation…"
            sleep 15
          done
          echo "DMG stapling failed after 3 attempts"
          exit 1

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.RELEASE_DMG }}
          generate_release_notes: true

      - name: Clean up keychain
        if: always()
        run: |
          security delete-keychain "$RUNNER_TEMP/signing.keychain-db" || true
